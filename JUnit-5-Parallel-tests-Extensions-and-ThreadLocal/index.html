<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"slinkydeveloper.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

  <meta name="description" content="In this blog post I&#39;ll talk about my story about enabling the Apache Flink project to use the new JUnit 5 features, including parallel execution, parametrized tests and extensions, and how they&#39;re goi">
<meta property="og:type" content="article">
<meta property="og:title" content="JUnit 5, Parallel tests, Extensions and ThreadLocal">
<meta property="og:url" content="https://slinkydeveloper.com/JUnit-5-Parallel-tests-Extensions-and-ThreadLocal/index.html">
<meta property="og:site_name" content="Slinky&#39;s corner">
<meta property="og:description" content="In this blog post I&#39;ll talk about my story about enabling the Apache Flink project to use the new JUnit 5 features, including parallel execution, parametrized tests and extensions, and how they&#39;re goi">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-02-19T11:25:15.000Z">
<meta property="article:modified_time" content="2023-08-28T15:56:42.185Z">
<meta property="article:author" content="Software Engineer">
<meta property="article:tag" content="testing">
<meta property="article:tag" content="junit5">
<meta property="article:tag" content="java">
<meta property="article:tag" content="flink">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://slinkydeveloper.com/JUnit-5-Parallel-tests-Extensions-and-ThreadLocal/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://slinkydeveloper.com/JUnit-5-Parallel-tests-Extensions-and-ThreadLocal/","path":"JUnit-5-Parallel-tests-Extensions-and-ThreadLocal/","title":"JUnit 5, Parallel tests, Extensions and ThreadLocal"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>JUnit 5, Parallel tests, Extensions and ThreadLocal | Slinky's corner</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-39408029-2"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-39408029-2","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#252e39"
    },
    "button": {
      "background": "#14a7d0"
    }
  }
})});
</script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Slinky's corner" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Slinky's corner</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Random programming stuff</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Our-test-codebase"><span class="nav-number">1.</span> <span class="nav-text">Our test codebase</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Goals"><span class="nav-number">2.</span> <span class="nav-text">Goals</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parallel-tests"><span class="nav-number">3.</span> <span class="nav-text">Parallel tests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Integration-tests-in-parallel"><span class="nav-number">4.</span> <span class="nav-text">Integration tests in parallel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Porting-the-test-suite-to-JUnit-5"><span class="nav-number">4.1.</span> <span class="nav-text">Porting the test suite to JUnit 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fixing-the-MiniCluster-extension-first"><span class="nav-number">4.2.</span> <span class="nav-text">Fixing the MiniCluster extension first</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Back-on-ParametrizedTest"><span class="nav-number">4.3.</span> <span class="nav-text">Back on @ParametrizedTest</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Results-and-conclusion"><span class="nav-number">5.</span> <span class="nav-text">Results and conclusion</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Software Engineer</p>
  <div class="site-description" itemprop="description">Personal blog of Francesco Guardiani, Software Engineer</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/slinkydeveloper" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;slinkydeveloper" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:me@slinkydeveloper.com" title="E-Mail → mailto:me@slinkydeveloper.com"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/francesco-guardiani" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;francesco-guardiani" rel="noopener" target="_blank"><i class="linkedin fa-fw"></i>LinkedIn</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/2399055/francesco-guardiani" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;2399055&#x2F;francesco-guardiani" rel="noopener" target="_blank"><i class="stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://slinkydeveloper.com/JUnit-5-Parallel-tests-Extensions-and-ThreadLocal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Software Engineer">
      <meta itemprop="description" content="Personal blog of Francesco Guardiani, Software Engineer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Slinky's corner">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JUnit 5, Parallel tests, Extensions and ThreadLocal
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 19-02-2022 12:25:15" itemprop="dateCreated datePublished" datetime="2022-02-19T12:25:15+01:00">19-02-2022</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 28-08-2023 17:56:42" itemprop="dateModified" datetime="2023-08-28T17:56:42+02:00">28-08-2023</time>
    </span>

  
</div>

            <div class="post-description">In this blog post I'll talk about my story about enabling the Apache Flink project to use the new JUnit 5 features, including parallel execution, parametrized tests and extensions, and how they're going to help us improve our test codebase.</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>In the <a target="_blank" rel="noopener" href="https://flink.apache.org/">Apache Flink</a> community we’re in the process of <a target="_blank" rel="noopener" href="https://lists.apache.org/thread/jsjvc2cqb91pyh47d4p6olk3c1vxqm3w">porting our huge test codebase to JUnit 5</a>. In order to leverage as much as we can the new JUnit 5 features, in the past days I’ve spent some time playing around with it.</p>
<p>In this blog post I’ll talk about my story about enabling the project to use the new JUnit 5 features, including parallel execution, parametrized tests and extensions, and how they’re going to help us improve our test codebase.</p>
<h2 id="Our-test-codebase">Our test codebase</h2>
<p>In Flink we’ve all kind of tests you can think of:</p>
<ul>
<li>Simple unit tests with a certain degree of mocking</li>
<li>Integration tests</li>
<li>End-to-end tests</li>
<li>Various other tests for utilities, such as tests for our bash scripts</li>
</ul>
<p>In most of the codebase, we refer to integration tests as tests that define and run a streaming job, but use a mocked sink and source. While end-to-end tests are like integration tests, but they use real external systems, such as Kafka, deployed with <a target="_blank" rel="noopener" href="https://www.testcontainers.org/test_framework_integration/junit_5/">TestContainers</a>.</p>
<p>In particular in Flink SQL, <em>unsurprisingly</em>, we have a lot of integration tests, because each single feature requires to be “understood” by all the different moving parts of our stack. For example, take the built-in function <code>COALESCE</code>: it has a runtime implementation, a Table API expression <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>, a custom logic for arguments type inference and return type inference, an optimizer rule that removes the call when possible. Each of these single pieces need to work in harmony, and integration tests usually gives us the guarantee that everything fits together.</p>
<p>Another aspect of JUnit 5 tests is that we have a lot of test bases and of parametrized test bases, à la Junit 4. This is due to the organic growth of the project and the effort to try to standardize certain test aspects, like starting and stopping a Flink <code>MiniCluster</code>, the embedded Flink cluster to run test jobs.</p>
<h2 id="Goals">Goals</h2>
<p>In porting to JUnit 5, we want to:</p>
<ul>
<li>Have less test bases, but more extensions, hence composition over inheritance. This simplifies contributing new tests, as adding a new “capability” to the test suite won’t require new ad-hoc test bases.</li>
<li>Improve error reporting and test cases separation, in order to make the contributor experience nicer both when running tests from the IDE and with Maven</li>
<li>Speedup the test suite as much as possible</li>
</ul>
<p>In particular the last point is a hot topic, as today a CI run usually takes between 1 and a half and 2 hours, having a significant impact on the development loop of the project.</p>
<h2 id="Parallel-tests">Parallel tests</h2>
<p>Parallel tests are, in my opinion, the killer feature of JUnit 5 and the real incentive to port JUnit 4 tests to JUnit 5.</p>
<p>With JUnit 4 you can parallelize test execution using the build tool, for example using <a target="_blank" rel="noopener" href="https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html"><code>maven-surefire-plugin</code> fork JVM feature</a>. It runs tests in parallel by spawning several JVM processes, where each of them gets assigned a split of the overall list of tests to run. JUnit 5 on the other hand runs all the tests within the same JVM: the test runner manages a thread pool and takes care of assigning test cases to threads.</p>
<p>I think the JUnit 5 approach fits best in our use case, as spawning several JVMs is very resource intensive on constrained machines such as CI runners, so it’s a constant source of issues. This statement is also valid for contributor’s machines, as these days just running the browser with 20+ tabs open, Spotify, Slack and the IDE can easily eat up to 16Gb of RAM. Plus they work in any IDE without additional configuration, they can help you find out thread safety bugs and the granularity of the execution is easy and flexible to configure.</p>
<p>To start using JUnit 5 parallel tests, we just had to create a file called <code>junit-platform.properties</code> in our test resources and add the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">junit.jupiter.execution.parallel.enabled = true</span><br><span class="line">junit.jupiter.execution.parallel.config.strategy = dynamic</span><br><span class="line">junit.jupiter.execution.parallel.mode.default = same_thread</span><br></pre></td></tr></table></figure>
<p>This configuration enables to opt-in specific tests/classes to run in parallel. To flag a test class to run in parallel, we need to annotate it with <code>@Execution(CONCURRENT)</code>. Thanks to this configuration we can gradually enable parallel execution only for tests we know are safe.</p>
<p>JUnit 5 offers the ability to configure the granularity of the parallel test execution, e.g. run all test cases from all classes in parallel, run all test cases from a class sequentially but run the test classes in parallel, etc. Check out all the available options in the <a target="_blank" rel="noopener" href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-parallel-execution">JUnit 5 documentation</a>.</p>
<p>So I’ve decided I wanted to try this new feature with some complex parametrized test base. I ended up choosing <a target="_blank" rel="noopener" href="https://github.com/apache/flink/blob/271c59332c794d86d221b4fe10c4435cc37d652f/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/functions/casting/CastRulesTest.java"><code>CastRulesTest</code></a>, a parametrized unit test base checking the runtime implementation of the <code>CAST</code> logic. Because there is no shared state whatsoever, this test suite is embarrassingly parallelizable. Just adding the annotation <code>@Execution(CONCURRENT)</code> gave me a 3x times faster execution time for the whole suite.</p>
<h2 id="Integration-tests-in-parallel">Integration tests in parallel</h2>
<p>That 3x totally got my attention, so I wanted to try to apply the same annotation to integration tests as well. As my next target, I’ve chosen <a target="_blank" rel="noopener" href="https://github.com/apache/flink/blob/3cf0393d8946df3aa7a8836f5b2291791c13f215/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/functions/BuiltInFunctionTestBase.java"><code>BuiltInFunctionTestBase</code></a>. As the name implies, this is a parametrized integration test base we use to test the correct behaviour of our built-in functions. We have around 10 classes where we use this test base, for a total of 1200+ integration test cases.</p>
<h3 id="Porting-the-test-suite-to-JUnit-5">Porting the test suite to JUnit 5</h3>
<p>The first thing I had to do was to port to JUnit 5 the base class and its inheritors. My initial thought was to use <a target="_blank" rel="noopener" href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-dynamic-tests"><code>@TestFactory</code> feature</a>, a new JUnit 5 feature to spawn dynamic tests, allowing you to group test cases. Think to it as a more powerful <code>@ParametrizedTest</code>.</p>
<p>This would have allowed me to have a nice nested view of the tests in the reports. For example, look at <a target="_blank" rel="noopener" href="https://github.com/apache/flink/blob/3cf0393d8946df3aa7a8836f5b2291791c13f215/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/functions/MathFunctionsITCase.java"><code>MathFunctionsITCase</code></a>: by mixing <code>DynamicTest</code> and <code>DynamicContainer</code> I could have achieved a report like:</p>
<ul>
<li><code>MathFunctionsITCase</code>:
<ul>
<li><code>PLUS</code>:
<ul>
<li><code>f0 + 6 = 20</code>: Success</li>
<li><code>f0 + 6 = 10</code>: Failure</li>
</ul>
</li>
<li><code>MINUS</code>: […]</li>
</ul>
</li>
</ul>
<p>Because the test base itself already had some models to define test cases, including input/output data, query expressions and configuration (see <a target="_blank" rel="noopener" href="https://github.com/apache/flink/blob/3cf0393d8946df3aa7a8836f5b2291791c13f215/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/functions/BuiltInFunctionTestBase.java#L183"><code>TestSpec</code></a>), what I had to do was simply to convert these models to <code>DynamicTest</code>/<code>DynamicContainer</code>. A little refactor of the <a target="_blank" rel="noopener" href="https://github.com/apache/flink/blob/3cf0393d8946df3aa7a8836f5b2291791c13f215/flink-table/flink-table-planner/src/test/java/org/apache/flink/table/planner/functions/BuiltInFunctionTestBase.java#L87"><code>testFunction</code> method</a> to wrap the logic into <code>DynamicTest</code> did it. Now every concrete test class just had to implement the abstract method <code>getTestSpecs</code> to return the test cases defined with my <code>TestSpec</code> class, so the final implementation of the <code>@TestFactory</code> just looked like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestFactory</span></span><br><span class="line">Stream&lt;DynamicContainer&gt; <span class="title function_">tests</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getTestSpecs().map(TestSpec::toDynamicContainer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Every implementation class provided a <code>DynamicContainer</code>, containing a set of tests for a specific built-in function, like <code>PLUS</code>, and each container had a set of <code>DynamicTest</code> with the specific test cases for that built-in function, like <code>f0 + 6 = 20</code>.</p>
<p>Last but not least, to let the query run, I needed the extension to set up <code>MiniCluster</code> once per class. This is already available in our <code>flink-test-utils</code>, so with some copy-paste I enabled it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">MiniClusterWithClientExtension</span> <span class="variable">MINI_CLUSTER_RESOURCE</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MiniClusterWithClientExtension</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MiniClusterResourceConfiguration</span>.Builder()</span><br><span class="line">                        .setNumberTaskManagers(<span class="number">1</span>)</span><br><span class="line">                        .build());</span><br><span class="line"></span><br><span class="line"><span class="meta">@RegisterExtension</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> AllCallbackWrapper&lt;MiniClusterWithClientExtension&gt; ALL_WRAPPER =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AllCallbackWrapper</span>&lt;&gt;(MINI_CLUSTER_RESOURCE);</span><br></pre></td></tr></table></figure>
<p>Tried a first run without parallel tests, and everything ran fine. Tried to add <code>@Execution(CONCURRENT)</code>, and Intellij IDEA welcomed my idea with a long report full of red crosses.</p>
<h3 id="Fixing-the-MiniCluster-extension-first">Fixing the <code>MiniCluster</code> extension first</h3>
<p>Looking at the logs, it became evident how the problem was <code>MiniClusterWithClientExtension</code>, given several tests were trying to push jobs to a <code>MiniCluster</code> already shut down.</p>
<p>The <code>MiniClusterWithClientExtension</code> was developed by wrapping the JUnit 4 <code>MiniClusterWithClientResource</code> rule in a custom interface defining <code>before</code> and <code>after</code>. Then, to register it, you could either use <code>AllCallbackWrapper</code> or <code>EachCallbackWrapper</code> to define whether to have one <code>MiniCluster</code> per test class, or per single test.</p>
<p>In JUnit 4 rules have a <code>before</code> and <code>after</code> extension point, and then when you register them, depending on whether you use <code>@Rule</code> or <code>@ClassRule</code>, the rule is executed for each test or once per class. In JUnit 5 the user cannot pick whether the extension is used globally or per method: it’s the extension itself that defines where it can hook in the lifecycle.</p>
<p>An example of this shift of concept between JUnit 4 and 5 is provided by the JUnit 5 <code>TestContainers</code> integration, which depending on whether the container field is static or not, decides to share it between test methods or not<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>.</p>
<p>Our <code>AllCallbackWrapper</code> or <code>EachCallbackWrapper</code> were circumventing the new JUnit 5 Extension paradigm, bringing back the same semantics of <code>@Rule</code> or <code>@ClassRule</code>. And this worked fine, until I tried to use parallel execution.</p>
<p>The <a target="_blank" rel="noopener" href="https://github.com/apache/flink/blob/78b231f60aed59061f0f609e0cfd659d78e6fdd5/flink-test-utils-parent/flink-test-utils/src/main/java/org/apache/flink/test/util/MiniClusterWithClientExtension.java#L68"><code>MiniClusterWithClientExtension#before</code></a> method was starting <code>MiniCluster</code>, creating some <code>ClusterClient</code> and then setting up a thread local for the environment configuration lookup.</p>
<p>The interaction between our <code>ThreadLocal</code> configuration when using <code>AllCallbackWrapper</code> didn’t sound right, so I tried to do a little experiment. Take this simple extension:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestExtension</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">BeforeEachCallback</span>, BeforeAllCallback, AfterEachCallback, AfterAllCallback &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAll</span><span class="params">(ExtensionContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before all: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeEach</span><span class="params">(ExtensionContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">&quot;before &quot;</span> + context.getDisplayName() + <span class="string">&quot;: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterEach</span><span class="params">(ExtensionContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">&quot;after &quot;</span> + context.getDisplayName() + <span class="string">&quot;: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">(ExtensionContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after all: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is simply going to print the thread where the various hooks are executed, and it also prints the name of single test in case in <code>beforeEach</code>/<code>afterEach</code>. Then I tried to run this test:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(TestExtension.class)</span></span><br><span class="line"><span class="meta">@Execution(ExecutionMode.CONCURRENT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ParameterizedTest(name = &quot;&#123;0&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ValueSource(ints = &#123;1, 2, 3, 4, 5, 6, 7, 8, 9, 10&#125;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">name</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test: &quot;</span> + i + <span class="string">&quot;, thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And here is the result:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">before all: ForkJoinPool-1-worker-1</span><br><span class="line">before 2: ForkJoinPool-1-worker-3</span><br><span class="line">before 3: ForkJoinPool-1-worker-4</span><br><span class="line">before 5: ForkJoinPool-1-worker-6</span><br><span class="line">before 9: ForkJoinPool-1-worker-1</span><br><span class="line">before 4: ForkJoinPool-1-worker-5</span><br><span class="line">before 7: ForkJoinPool-1-worker-0</span><br><span class="line">before 6: ForkJoinPool-1-worker-7</span><br><span class="line">before 1: ForkJoinPool-1-worker-2</span><br><span class="line">test: 7, thread: ForkJoinPool-1-worker-0</span><br><span class="line">test: 9, thread: ForkJoinPool-1-worker-1</span><br><span class="line">test: 4, thread: ForkJoinPool-1-worker-5</span><br><span class="line">test: 1, thread: ForkJoinPool-1-worker-2</span><br><span class="line">test: 6, thread: ForkJoinPool-1-worker-7</span><br><span class="line">test: 2, thread: ForkJoinPool-1-worker-3</span><br><span class="line">test: 3, thread: ForkJoinPool-1-worker-4</span><br><span class="line">test: 5, thread: ForkJoinPool-1-worker-6</span><br><span class="line">after 4: ForkJoinPool-1-worker-5</span><br><span class="line">after 7: ForkJoinPool-1-worker-0</span><br><span class="line">after 6: ForkJoinPool-1-worker-7</span><br><span class="line">after 1: ForkJoinPool-1-worker-2</span><br><span class="line">after 5: ForkJoinPool-1-worker-6</span><br><span class="line">after 9: ForkJoinPool-1-worker-1</span><br><span class="line">after 3: ForkJoinPool-1-worker-4</span><br><span class="line">after 2: ForkJoinPool-1-worker-3</span><br><span class="line">before 8: ForkJoinPool-1-worker-3</span><br><span class="line">test: 8, thread: ForkJoinPool-1-worker-3</span><br><span class="line">before 10: ForkJoinPool-1-worker-6</span><br><span class="line">after 8: ForkJoinPool-1-worker-3</span><br><span class="line">test: 10, thread: ForkJoinPool-1-worker-6</span><br><span class="line">after 10: ForkJoinPool-1-worker-6</span><br><span class="line">after all: ForkJoinPool-1-worker-1</span><br></pre></td></tr></table></figure>
<p>As I was expecting, <code>beforeEach</code> and <code>afterEach</code> runs in the same thread of the test, as effectively they just “wrap” the test method, as described <a target="_blank" rel="noopener" href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/BeforeEachCallback.html">here</a>.</p>
<p>In other words:</p>
<ul>
<li>There is no guarantee about which thread is used to execute <code>beforeAll</code> and <code>afterAll</code>, but</li>
<li><code>beforeEach</code> and <code>afterEach</code> are guaranteed to be executed within the same thread of the test</li>
</ul>
<p>So here was the solution: we just had to set/unset that <code>ThreadLocal</code> <strong>everytime</strong> in <code>beforeEach</code>/<code>afterEach</code>, no matter whether the <code>MiniCluster</code> instance was meant to be per test class or per test method.</p>
<p>I was ready to declare victory, so I did some refactoring of <code>MiniClusterWithClientExtension</code> to always create one <code>MiniCluster</code> per test class, I removed the wrapping around <code>AllCallbackWrapper</code> and then I tried to run again my tests: still everything was red.</p>
<h3 id="Back-on-ParametrizedTest">Back on <code>@ParametrizedTest</code></h3>
<p>After some investigation, I found out that <code>DynamicTest</code> lifecycle doesn’t work per <code>DynamicTest</code> instance, while parallelization does. For example, for this test class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(TestExtension.class)</span></span><br><span class="line"><span class="meta">@Execution(ExecutionMode.CONCURRENT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TestFactory</span></span><br><span class="line">    <span class="keyword">public</span> Stream&lt;DynamicTest&gt; <span class="title function_">tests</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">                .mapToObj(i -&gt;</span><br><span class="line">                  DynamicTest.dynamicTest(</span><br><span class="line">                    String.valueOf(i),</span><br><span class="line">                    () -&gt; System.out.println(<span class="string">&quot;test: &quot;</span> + i + <span class="string">&quot;, thread: &quot;</span> + Thread.currentThread().getName())</span><br><span class="line">                  ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You get this output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">before all: ForkJoinPool-1-worker-1</span><br><span class="line">before tests(): ForkJoinPool-1-worker-1</span><br><span class="line">after tests(): ForkJoinPool-1-worker-1</span><br><span class="line">test: 2, thread: ForkJoinPool-1-worker-3</span><br><span class="line">test: 6, thread: ForkJoinPool-1-worker-7</span><br><span class="line">test: 3, thread: ForkJoinPool-1-worker-4</span><br><span class="line">test: 9, thread: ForkJoinPool-1-worker-1</span><br><span class="line">test: 7, thread: ForkJoinPool-1-worker-0</span><br><span class="line">test: 1, thread: ForkJoinPool-1-worker-2</span><br><span class="line">test: 4, thread: ForkJoinPool-1-worker-5</span><br><span class="line">test: 5, thread: ForkJoinPool-1-worker-6</span><br><span class="line">test: 8, thread: ForkJoinPool-1-worker-3</span><br><span class="line">test: 10, thread: ForkJoinPool-1-worker-2</span><br><span class="line">after all: ForkJoinPool-1-worker-1</span><br></pre></td></tr></table></figure>
<p>As you see, each <code>DynamicTest</code> is executed in parallel, as you would expect, but the <code>beforeEach</code> and <code>afterEach</code> is executed only once per <code>@TestFactory</code>. Because of this behaviour, the tests were not picking the correct <code>ThreadLocal</code>, hence failing the test because they could not find the <code>MiniCluster</code>.</p>
<p>It seems like there is no solution to this problem, and there is an issue open in the <a target="_blank" rel="noopener" href="https://github.com/junit-team/junit5/issues/378">JUnit 5 issue tracker</a> about whether this should be supported or not.</p>
<p>So I had to fall back to the good old <code>@ParametrizedTest</code>: I just removed the nested <code>DynamicContainer</code>, and I created my own <code>DynamicTest</code> like data structure to wrap a test <code>Executable</code> and its display name:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Single test case. */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executable executable;</span><br><span class="line"></span><br><span class="line">    TestCase(String name, Executable executable) &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.executable = executable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And then I kept the same code as before in the test base, but I had to add a method to flatten the previously used <code>DynamicContainer</code>s:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> Stream&lt;TestSpec&gt; <span class="title function_">getTestSpecs</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Stream&lt;TestCase&gt; <span class="title function_">getTestCases</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getTestSpecs()</span><br><span class="line">            .flatMap(testSpec -&gt; testSpec.getTestCases(<span class="built_in">this</span>.getConfiguration()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@MethodSource(&quot;getTestCases&quot;)</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(TestCase testCase)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    testCase.executable.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The report doesn’t look as nice as with <code>@TestFactory</code>, but it finally works fine with parallel execution.</p>
<h2 id="Results-and-conclusion">Results and conclusion</h2>
<p>Before the parallelization, this test suite ran in around 50 seconds from Intellij IDEA on my i7 11th Gen packed with 16Gb of RAM. After the parallelization the suite runs in around 20 seconds<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>. Not bad.</p>
<p>I think JUnit 5 is a very powerful tool, but you need to be careful when developing extensions that are supposed to work with parallel tests. These are my gotchas from this experience:</p>
<ul>
<li>Make sure thread locals are set in <code>beforeEach</code>, so they’re set in the right thread, and <strong>cleaned up</strong> in <code>afterEach</code>, to avoid next tests reusing that thread to pick up the old <code>ThreadLocal</code> values</li>
<li>Be aware that the method <code>beforeEach</code> could be invoked in parallel on the same instance of the extension, so you need to make sure the access to extension fields is thread safe, or…</li>
<li>Use the <code>ExtensionContext.Store</code>, as it’s thread safe, it’s hierarchically organized per hook context, and it’s particularly useful to auto cleanup objects built in the <code>before[..]</code> methods</li>
<li>Rather than providing accessors in the extension class, use parameter injection implementing <code>ParameterResolver</code> together with the <code>ExtensionContext.Store</code>. This simplifies the implementation when storing your extension state in <code>ExtensionContext.Store</code>.</li>
</ul>
<p>And last but not least, don’t use <code>@TestFactory</code> in conjunction with parallel execution if your test requires <code>ThreadLocal</code> or other thread dependant thing correctly configured.</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>The DSL provided by Flink SQL to define relational queries without SQL <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.testcontainers.org/test_framework_integration/junit_5/">TestContainers - JUnit 5 integration</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>Please take these numbers with a grain of salt, my measurements were very empirical, and not proper benchmarks <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/testing/" rel="tag"># testing</a>
              <a href="/tags/junit5/" rel="tag"># junit5</a>
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/flink/" rel="tag"># flink</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Kubernetes-controllers-The-Empire-Strikes-Back/" rel="prev" title="Kubernetes controllers - The Empire Strikes Back">
                  <i class="fa fa-chevron-left"></i> Kubernetes controllers - The Empire Strikes Back
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/rust-macros-are-not-just-about-dry/" rel="next" title="Rust macros are not just about DRY">
                  Rust macros are not just about DRY <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Software Engineer</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.10/dist/mermaid.min.js","integrity":"sha256-CmZCFVnvol9YL23PfjDflGY5nJwE+Mf/JN+8v+tD/34="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>


  





</body>
</html>
