<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




















  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/fancybox@3.0.0/dist/css/jquery.fancybox.min.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=6.7.0">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=6.7.0" color="#222">


  <link rel="manifest" href="/images/manifest.json">






<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  

<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#252e39"
    },
    "button": {
      "background": "#14a7d0"
    }
  }
})});
</script>

  <meta name="description" content="Can we improve speed of vert-x web using a tree structure?">
<meta name="keywords" content="web development,vertx,vertx web,routing,data structures,tree,skiplist">
<meta property="og:type" content="article">
<meta property="og:title" content="Tree vs SkipList routing">
<meta property="og:url" content="https://slinkydeveloper.github.io/Routing-Tree-vs-SkipList/index.html">
<meta property="og:site_name" content="Slinky&#39;s corner">
<meta property="og:description" content="Can we improve speed of vert-x web using a tree structure?">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/ecommerce-tree.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/social-tree.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/basic_complex.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/basic_social.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/with_load_complex.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/with_load_social.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/complex_complete.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/social_complete.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/complex_average.png">
<meta property="og:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/social_average.png">
<meta property="og:updated_time" content="2019-01-20T16:28:08.116Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tree vs SkipList routing">
<meta name="twitter:description" content="Can we improve speed of vert-x web using a tree structure?">
<meta name="twitter:image" content="https://slinkydeveloper.github.io/images/tree-vs-router/ecommerce-tree.png">



  <link rel="alternate" href="/atom.xml" title="Slinky's corner" type="application/atom+xml">




  <link rel="canonical" href="https://slinkydeveloper.github.io/Routing-Tree-vs-SkipList/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Tree vs SkipList routing | Slinky's corner</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-39408029-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-39408029-2');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Slinky's corner</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Personal blog of Francesco Guardiani, Software Engineer</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://slinkydeveloper.github.io/Routing-Tree-vs-SkipList/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Software Engineer">
      <meta itemprop="description" content="Personal blog of Francesco Guardiani, Software Engineer">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Slinky's corner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tree vs SkipList routing

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 25-09-2017 10:51:22" itemprop="dateCreated datePublished" datetime="2017-09-25T10:51:22+02:00">25-09-2017</time>
            

            
          </span>

          

          
            
          

          
          

          

          

          
              <div class="post-description">Can we improve speed of vert-x web using a tree structure?</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>One of the most important features of web frameworks is performance and the routing process can become an important performance killer. I&#x2019;m going to introduce you a comparison between the list (in particular the skip list) and the tree as data structure for web framework&#x2019;s routers.</p>
<h2 id="Why-this-article"><a href="#Why-this-article" class="headerlink" title="Why this article"></a>Why this article</h2><p>Routing consists in calling the correct handler for the URL that user requested. Sometimes this can be a simple and fast process, but in modern scenarios most times this process slows your application, in particular when:</p>
<ul>
<li>You have a huge list of routes</li>
<li>You rely on path parameters (sometimes 2 or more path parameters in the same route)</li>
<li>You want to run multiple handlers for every URL segment</li>
</ul>
<p>I&#x2019;m writing this article because <a href="https://github.com/vert-x3/vertx-web/issues/678" target="_blank" rel="noopener">I want to implement a tree router inside Vert.x Web framework</a>, so I&#x2019;m investigating around to find what the best solution would be.</p>
<h2 id="List-routing-vs-Tree-routing"><a href="#List-routing-vs-Tree-routing" class="headerlink" title="List routing vs Tree routing"></a>List routing vs Tree routing</h2><p>A <strong>Route</strong> is a combination of HTTP method and path. The path can be a simple constant path or a path with one or more parameters, managed via regular expressions.</p>
<p>The <strong>list routing</strong> uses a list to contain all defined routes (in a precise order). When the server receives a request, the router iterates through the list and searches for the routes that match with the received request. This process <strong>cannot be</strong> a simple list search, because a request can match multiple times. For example: if we have a router that declares</p>
<ul>
<li><code>GET &quot;/&quot;</code></li>
<li><code>GET &quot;/users&quot;</code></li>
<li><code>GET &quot;/users/userA&quot;</code></li>
</ul>
<p>and we receive <code>/users/userA</code> as request, the router has to run all the handlers of these three routes.</p>
<p>The <strong>tree routing</strong> differs from list routing for one simple thing: the routes are inside a tree. So when the router receives the request, it follows the tree searching for matching routes</p>
<p>When you think about a website (or, in the same situation, a web API) you think about a tree of web pages (operations) you can retrieve (perform). But most of the web frameworks don&#x2019;t implement the routing as a tree of resources, for multiple reasons:</p>
<ul>
<li>It&#x2019;s difficult to build a routing codebase around a concurrent tree preserving good performances</li>
<li>Does the user manually build the routing tree or is the insertion a task for the algorithm? And how can we manage the regular expressions inside this insertion algorithm?</li>
<li>Modern lists (for example the SkipList) are really powerful and <a href="https://en.wikipedia.org/wiki/Skip_list" target="_blank" rel="noopener">can obtain performances similar to trees</a> mantaining the routing codebase simple</li>
</ul>
<p>But, not considering these problems, the tree seems a better solution for this problem, right? This is the starting thesis, now I need to prove it.</p>
<p>Before starting, I want to underline that some frameworks have succesfully implemented the tree routing, for example <a href="https://github.com/fastify/fastify" target="_blank" rel="noopener">Fastify</a>, achieving really interesting <a href="https://github.com/fastify/fastify#benchmarks" target="_blank" rel="noopener">performances</a></p>
<h2 id="Reproduce-the-two-types-of-routers"><a href="#Reproduce-the-two-types-of-routers" class="headerlink" title="Reproduce the two types of routers"></a>Reproduce the two types of routers</h2><p>The first step is creating the sketches of these two routing mechanisms. I&#x2019;ve tried to create the list routing similar to Vert.x Web router, but of course these are only <strong>simplified examples</strong>. The router of a web framework is more complex than my 50 lines of code. The list router is implemented inside class <a href="https://github.com/slinkydeveloper/tree-list-routing-java-bench/blob/master/src/main/java/io/slinkydeveloper/bench/ListRouter.java" target="_blank" rel="noopener"><code>ListRouter</code></a> and tree router is implemented inside class <a href="https://github.com/slinkydeveloper/tree-list-routing-java-bench/blob/master/src/main/java/io/slinkydeveloper/bench/TreeRouter.java" target="_blank" rel="noopener"><code>TreeRouter</code></a>.</p>
<p>The list router has a simple loop that calls for every route the function <code>route()</code>; when this function returns true, the route matches perfectly and the routing process stops. Remember that when I check if route <em>matches</em> (both in tree and list scenario) the router:</p>
<ol>
<li>first checks if the path matches partially (in case of regexes it calls <code>lookingAt()</code> method, while in string paths it calls the method <code>startsWith()</code>)</li>
<li>Then it checks if the path matches totally (methods <code>matches()</code> and <code>equals()</code>). If the path matches totally, the routing stops</li>
</ol>
<p>The tree routing is a simple recursive function that works as follow:</p>
<ul>
<li>Base case: The path chunk is empty so we have finished the routing succesfully</li>
<li>If not base case: We try to match <strong>partially</strong> first the constant paths and then the regular expressions. If we found a match, we go deeper with recursion</li>
<li>If we don&#x2019;t find any match the requested route doesn&#x2019;t exist and the routing process stops</li>
</ul>
<p>We test against path chunks for a simple reason: when we go deeper with recursion we don&#x2019;t need to test against previous path components (and we don&#x2019;t need to re-extract the parameters), so the router simply removes it from the requested URL. And of course when the string is empty we have finished the routing. To gain good performances inside tree nodes I used the skip lists (I know I&#x2019;ve cheated) to contain associated routes.</p>
<p>This is only a way to implement the tree routing and also remember that I haven&#x2019;t written the insertion algorithm for the tree router, so I do all association between nodes manually.</p>
<h2 id="Two-common-API-scenarios"><a href="#Two-common-API-scenarios" class="headerlink" title="Two common API scenarios"></a>Two common API scenarios</h2><p>I&#x2019;ve created two benchmarks: an example of ecommerce API and a social network API. This examples are really similar, they only differ in number of routes and how many regular expression are contained in said routes. Below you can see how this &#x201C;fake&#x201D; routers are composed.</p>
<figure><br>  <a href="/images/tree-vs-router/ecommerce-tree.png" class="image-popup"><img src="/images/tree-vs-router/ecommerce-tree.png" alt="image"></a><br>  <figcaption>Router created for ECommerceBenchmark</figcaption><br></figure>

<figure><br>  <a href="/images/tree-vs-router/social-tree.png" class="image-popup"><img src="/images/tree-vs-router/social-tree.png" alt="image"></a><br>  <figcaption>Router created for SocialNetworkBenchmark</figcaption><br></figure>

<h2 id="Maybe-Skip-List-is-better"><a href="#Maybe-Skip-List-is-better" class="headerlink" title="Maybe Skip List is better?"></a>Maybe Skip List is better?</h2><p>The first benchmarks I wrote are simple accesses to routes. I wrote one benchmark for every route (that I store in <code>compatiblePaths</code>) and every data structure. Below you can find results of <a href="https://github.com/slinkydeveloper/tree-list-routing-java-bench/blob/master/src/main/java/io/slinkydeveloper/bench/ECommerceBenchmark.java" target="_blank" rel="noopener"><code>ECommerceBenchmark</code></a>:</p>
<figure><br>  <a href="/images/tree-vs-router/basic_complex.png" class="image-popup"><img src="/images/tree-vs-router/basic_complex.png" alt="image"></a><br>  <figcaption>Benchmark results for ECommerceBenchmark based on requested URLs</figcaption><br></figure>

<p>The first observation is that the constant paths in skip list are faster than in the tree router. This is caused by skip list optimization: when we get the same elements multiple times the skip list optimizes its links to access more quickly to its values. But the performances for skip lists falls in favor of tree when we use regular expressions, because of course we give a smaller string to the regular expression engine. With the <code>/health</code> path we have a little difference because in tree we are at the first level, while in <code>/user/newUser</code> we are one level deeper than <code>/health</code>. This results are confirmed by the <a href="https://github.com/slinkydeveloper/tree-list-routing-java-bench/blob/master/src/main/java/io/slinkydeveloper/bench/SocialNetworkBenchmark.java" target="_blank" rel="noopener"><code>SocialNetworkBenchmark</code></a> with the same configuration:</p>
<figure><br>  <a href="/images/tree-vs-router/basic_social.png" class="image-popup"><img src="/images/tree-vs-router/basic_social.png" alt="image"></a><br>  <figcaption>Benchmark results for SocialNetworkBenchmark based on requested URLs</figcaption><br></figure>

<p>So maybe skip lists are so fast that trees are not competitive in this application field? I&#x2019;ve done two considerations:</p>
<ol>
<li>In a real case situation a router doesn&#x2019;t receive <strong>12.000.000 same requests</strong> in one second, but maybe if it receives 1.000 same requests (for example the <code>/feed</code> request) the skip list optimization helps a lot</li>
<li>My tree implementation is rude compared to JDK&#x2019;s <code>ConcurrentSkipListSet</code></li>
</ol>
<h2 id="And-if-I-add-some-spice"><a href="#And-if-I-add-some-spice" class="headerlink" title="And if I add some spice?"></a>And if I add some spice?</h2><p>To confuse the skip list I&#x2019;ve created a more <em>real</em> scenario: The benchmark function does 10 random requests and then the request assigned. This process complicates things a bit for the skip list, because it loses the optimization:</p>
<figure><br>  <a href="/images/tree-vs-router/with_load_complex.png" class="image-popup"><img src="/images/tree-vs-router/with_load_complex.png" alt="image"></a><br>  <figcaption>Benchmark results for ECommerceBenchmark based on requested URLs with 10 random requests</figcaption><br></figure>

<p>And of course it&#x2019;s a win for the tree. The fun fact is that tree defeats the skip list also in first paths.</p>
<p>For the social benchmark the random function that chooses the 10 requests is little bit hacky: Some paths (for example the <code>/feed</code>) have more chances than other ones. But the results remain the same:</p>
<figure><br>  <a href="/images/tree-vs-router/with_load_social.png" class="image-popup"><img src="/images/tree-vs-router/with_load_social.png" alt="image"></a><br>  <figcaption>Benchmark results for SocialNetworkBenchmark based on requested URLs with 10 random requests</figcaption><br></figure>

<p>The results on <code>SocialNetworkBenchmark</code> are impressive because with some paths we have 3x or more performances for tree router, but we have an unstable situation at the same level.</p>
<p>There&#x2019;s also an important consideration to do: When we go deeper, tree performances slope down, so to write a good tree router we need a good combination of access optimizations and insertion algorithm that avoids creating uselessly deep nodes.</p>
<p>You can find below the final results with and without load (&#x201C;with load&#x201D; values conveniently scaled x11):</p>
<figure><br>  <a href="/images/tree-vs-router/complex_complete.png" class="image-popup"><img src="/images/tree-vs-router/complex_complete.png" alt="image"></a><br>  <figcaption>Final benchmark results for ECommerceBenchmark</figcaption><br></figure>

<figure><br>  <a href="/images/tree-vs-router/social_complete.png" class="image-popup"><img src="/images/tree-vs-router/social_complete.png" alt="image"></a><br>  <figcaption>Final benchmark results for SocialNetworkBenchmark</figcaption><br></figure>

<h2 id="And-it&#x2019;s-not-finished"><a href="#And-it&#x2019;s-not-finished" class="headerlink" title="And it&#x2019;s not finished!"></a>And it&#x2019;s not finished!</h2><p>For the two test cases and data structures I also wrote a <em>final benchmark</em> that accesses to <code>compatiblePaths</code> sequentially and in both cases it&#x2019;s a huge win for tree:</p>
<figure class="half"><br>    <a href="/images/tree-vs-router/complex_average.png" class="image-popup"><img src="/images/tree-vs-router/complex_average.png" alt="image"></a><br>    <a href="/images/tree-vs-router/social_average.png" class="image-popup"><img src="/images/tree-vs-router/social_average.png" alt="image"></a><br>    <figcaption>Final results (left e-commerce benchmark, right social benchmark)</figcaption><br></figure>

<p>But this is not a very realistic situation, because usually we have a situation like the social network benchmark with load: we have more frequent requests and less frequent requests, but it&#x2019;s unusual to get requests ordered in the router order sequentially.</p>
<h2 id="So-what&#x2019;s-better"><a href="#So-what&#x2019;s-better" class="headerlink" title="So, what&#x2019;s better?"></a>So, what&#x2019;s better?</h2><p>That&#x2019;s an hard question, because these examples don&#x2019;t prove a lot. But, according to this data, it makes sense to start developing a tree router because we have good preconditions. In some situations with regular expressions we have seen up to 2x performances thanks to the tree router, but it&#x2019;s important to get good performances also with constant paths (remember that when we have query parameters like <code>/user?q=blabla</code> these URLs are splitted at the start of routing and the router treats this requests like constant paths).</p>
<h2 id="Implementing-a-Tree-Router-challenging-tasks"><a href="#Implementing-a-Tree-Router-challenging-tasks" class="headerlink" title="Implementing a Tree Router: challenging tasks"></a>Implementing a Tree Router: challenging tasks</h2><h3 id="Insertion-algorithm"><a href="#Insertion-algorithm" class="headerlink" title="Insertion algorithm"></a>Insertion algorithm</h3><p>The insertion algorithm is the most important challange for different reasons:</p>
<ol>
<li>Providing an optimization at every insertion</li>
<li>Splitting constant paths and mostly importantly</li>
<li><strong>Splitting regular expressions</strong></li>
</ol>
<p>The idea of insertion is not splitting for every <code>/</code> (like I&#x2019;ve done in my examples) but something more like this:</p>
<ol>
<li>At the start we have an empty root node</li>
<li>When I add a route I assign it to the root node</li>
<li>When I add another route I check if it&#x2019;s a child of the root node or if I can split the root node in two nodes. In the first case I simply add the new route inside the list of childs, in the second case I split the root node creating two child nodes and assigning to the root node the shared first part of path</li>
</ol>
<p>For example:</p>
<table>
<thead>
<tr>
<th>Path inserted</th>
<th>Tree update</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>Empty root node</td>
</tr>
<tr>
<td>/users/{user_id}</td>
<td>Root node with assigned &#x201C;/users/{user_id}&#x201D;</td>
</tr>
<tr>
<td>/users/addUser</td>
<td>Root node assigned with &#x201C;/users/&#x201C; and with childs &#x201C;{user_id}&#x201D; and &#x201C;addUser&#x201D;</td>
</tr>
<tr>
<td>/users/addFacebookUser</td>
<td>&#x201C;addUser&#x201D; splitted in new node with &#x201C;add&#x201D; and childs &#x201C;User&#x201D; and &#x201C;FacebookUser&#x201D;</td>
</tr>
</tbody>
</table>
<p>The last task in particular is very tricky, because a simple char to char comparison is very limiting and also can generate not working regular expressions. For example: path <code>/([a-b]{0, 9})</code> and path <code>/([a-z]{0, 9})</code> cannot be splitted creating a parent node with <code>/([a</code>, because of course this regular expression is invalid. I&#x2019;ve got some ideas about it:</p>
<ul>
<li>First I check if two routes have the same regular expressions in the middle. For example when we have <code>/users/{user_id}/feed</code> and <code>/users/{user_id}/events</code> we split it into <code>/users/{user_id}/</code> with childs <code>feed</code> and <code>events</code>. This can be done with some regular expressions</li>
<li>If a regular expression is at the end of a path, I split at the last constant <code>/</code> (not inside a group).</li>
<li>If none of the previous, I treat it as first level child</li>
</ul>
<p>To do these things maybe a library that helps &#x201C;understanding&#x201D; regular expressions could come in handy.</p>
<h3 id="Mantaining-good-performances-during-routing"><a href="#Mantaining-good-performances-during-routing" class="headerlink" title="Mantaining good performances during routing"></a>Mantaining good performances during routing</h3><p>I really don&#x2019;t have idea how <span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png?v8">&#x1F604;</span>. I want to start creating a simple router that does only the minimal routing and then I add conditions necessary to successfully pass the tests. Maybe operating in this way I can avoid creation of useless code.</p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>Router Tree is possible and can give great performances to Vert.x Web. I cannot wait to start working on it!</p>
<p>Stay tuned!</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web-development/" rel="tag"># web development</a>
          
            <a href="/tags/vertx/" rel="tag"># vertx</a>
          
            <a href="/tags/vertx-web/" rel="tag"># vertx web</a>
          
            <a href="/tags/routing/" rel="tag"># routing</a>
          
            <a href="/tags/data-structures/" rel="tag"># data structures</a>
          
            <a href="/tags/tree/" rel="tag"># tree</a>
          
            <a href="/tags/skiplist/" rel="tag"># skiplist</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/My-GSoC-2017-Slush-Vertx/" rel="next" title="My GSoC 2017 - Slush-vertx">
                <i class="fa fa-chevron-left"></i> My GSoC 2017 - Slush-vertx
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Routing-With-Eclipse-Collections/" rel="prev" title="Routing with Eclipse Collections">
                Routing with Eclipse Collections <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Software Engineer</p>
              <p class="site-description motion-element" itemprop="description">Personal blog of Francesco Guardiani, Software Engineer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">28</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/slinkydeveloper" title="GitHub &rarr; https://github.com/slinkydeveloper" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:francescoguard@gmail.com" title="E-Mail &rarr; mailto:francescoguard@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/SlinkyGuardiani" title="Twitter &rarr; https://twitter.com/SlinkyGuardiani" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://stackoverflow.com/users/2399055/francesco-guardiani" title="StackOverflow &rarr; https://stackoverflow.com/users/2399055/francesco-guardiani" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-this-article"><span class="nav-number">1.</span> <span class="nav-text">Why this article</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#List-routing-vs-Tree-routing"><span class="nav-number">2.</span> <span class="nav-text">List routing vs Tree routing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reproduce-the-two-types-of-routers"><span class="nav-number">3.</span> <span class="nav-text">Reproduce the two types of routers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Two-common-API-scenarios"><span class="nav-number">4.</span> <span class="nav-text">Two common API scenarios</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Maybe-Skip-List-is-better"><span class="nav-number">5.</span> <span class="nav-text">Maybe Skip List is better?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#And-if-I-add-some-spice"><span class="nav-number">6.</span> <span class="nav-text">And if I add some spice?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#And-it’s-not-finished"><span class="nav-number">7.</span> <span class="nav-text">And it’s not finished!</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#So-what’s-better"><span class="nav-number">8.</span> <span class="nav-text">So, what’s better?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-a-Tree-Router-challenging-tasks"><span class="nav-number">9.</span> <span class="nav-text">Implementing a Tree Router: challenging tasks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Insertion-algorithm"><span class="nav-number">9.1.</span> <span class="nav-text">Insertion algorithm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mantaining-good-performances-during-routing"><span class="nav-number">9.2.</span> <span class="nav-text">Mantaining good performances during routing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusions"><span class="nav-number">10.</span> <span class="nav-text">Conclusions</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Software Engineer</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="//cdn.jsdelivr.net/npm/fancybox@3.0.0/dist/js/jquery.fancybox.pack.js"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
