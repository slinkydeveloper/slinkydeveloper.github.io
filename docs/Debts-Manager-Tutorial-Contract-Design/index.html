<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




















  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/fancybox@3.0.0/dist/css/jquery.fancybox.min.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=6.7.0">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=6.7.0" color="#222">


  <link rel="manifest" href="/images/manifest.json">






<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  

<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#252e39"
    },
    "button": {
      "background": "#14a7d0"
    }
  }
})});
</script>

  <meta name="description" content="In this second chapter of Debts Manager Tutorial I would like to show you how I have designed the REST API of Debts Manager. I&apos;m going to follow the API First approach, documenting all aspects of the">
<meta name="keywords" content="openapi,vertx,development,web,web api contract,openapi 3">
<meta property="og:type" content="article">
<meta property="og:title" content="Debts Manager Tutorial Part 2: Contract Design">
<meta property="og:url" content="https://slinkydeveloper.github.io/Debts-Manager-Tutorial-Contract-Design/index.html">
<meta property="og:site_name" content="Slinky&#39;s corner">
<meta property="og:description" content="In this second chapter of Debts Manager Tutorial I would like to show you how I have designed the REST API of Debts Manager. I&apos;m going to follow the API First approach, documenting all aspects of the">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-01-20T16:28:08.117Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Debts Manager Tutorial Part 2: Contract Design">
<meta name="twitter:description" content="In this second chapter of Debts Manager Tutorial I would like to show you how I have designed the REST API of Debts Manager. I&apos;m going to follow the API First approach, documenting all aspects of the">



  <link rel="alternate" href="/atom.xml" title="Slinky's corner" type="application/atom+xml">




  <link rel="canonical" href="https://slinkydeveloper.github.io/Debts-Manager-Tutorial-Contract-Design/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Debts Manager Tutorial Part 2: Contract Design | Slinky's corner</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-39408029-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-39408029-2');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Slinky's corner</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Personal blog of Francesco Guardiani, Software Engineer</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://slinkydeveloper.github.io/Debts-Manager-Tutorial-Contract-Design/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Software Engineer">
      <meta itemprop="description" content="Personal blog of Francesco Guardiani, Software Engineer">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Slinky's corner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Debts Manager Tutorial Part 2: Contract Design

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 20-01-2019 09:10:00" itemprop="dateCreated datePublished" datetime="2019-01-20T09:10:00+01:00">20-01-2019</time>
            

            
          </span>

          

          
            
          

          
          

          

          

          
              <div class="post-description">In this second chapter of Debts Manager Tutorial I would like to show you how I have designed the REST API of Debts Manager. I'm going to follow the API First approach, documenting all aspects of the API Design with OpenAPI 3.</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Hi guys! Welcome back to this tutorial!</p>
<p>In this second chapter of Debts Manager Tutorial I would like to show you how I have designed the REST API of Debts Manager. I&#x2019;m going to follow the <em>API First</em> approach, documenting all aspects of the API Design with OpenAPI 3.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>The REST APIs, in contrast with RPC, are driven by the data the services wants to expose. In the previous chapter I gave you an idea of the entities we must expose. Now I tabulate these and the relative operations on it.</p>
<table>
<thead>
<tr>
<th>Entity</th>
<th>Create</th>
<th>Retrieve</th>
<th>Update</th>
<th>Delete</th>
</tr>
</thead>
<tbody>
<tr>
<td>User</td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
</tr>
<tr>
<td>User relationship</td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
</tr>
<tr>
<td>Transaction</td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
</tr>
<tr>
<td>Status</td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2714.png?v8">&#x2714;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
<td><span class="github-emoji" style="color: transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8">&#x274C;</span></td>
</tr>
</tbody>
</table>
<p>This table is a pretty good starting point, but I must refine the analysis enforcing our methods with policies and logics.</p>
<p>These policies are primarly based on <em>who is making the request</em>. I&#x2019;m going to define a login phase together with JWT to provide authorization and authentication. Each endpoint, except <code>login</code> and <code>register</code>, is secured with a JWT auth. My objective is expose, for each user, only a subset of data relative to the user itself.</p>
<h2 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h2><p>Before defining the endpoints I must formally describe the data models representing the service entities. OpenAPI has its own Json Schema dialect to define models: <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#schemaObject" target="_blank" rel="noopener">OpenAPI Schema</a>. This is an extended subset of <a href="http://json-schema.org/specification-links.html#draft-5" target="_blank" rel="noopener">Json Schema Draft 5</a>. Meanwhile I&#x2019;m writing, there is a proposal to allow usage of every version of Json Schema, including the newer versions, with an extension <a href="https://github.com/OAI/OpenAPI-Specification/issues/1532" target="_blank" rel="noopener">https://github.com/OAI/OpenAPI-Specification/issues/1532</a>.</p>
<p>I place these schemas in main OpenAPI file under <code>components</code> and <code>schemas</code> keywords. I can refeer to it using Json schema references (<code>$ref</code> keyword).</p>
<p>The simplest model here is the user. I want to expose only the username, so I represent it with a simple <code>string</code>. This is the definition using OpenAPI Schema:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Username:</span></span><br><span class="line"><span class="attr">  minLength:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">string</span></span><br></pre></td></tr></tbody></table></figure>
<p>The status is represented by a map with users as keys and total debts\credits as values. In OpenAPI Schema:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Status:</span></span><br><span class="line"><span class="attr">  description:</span> <span class="string">&apos;Map with username as keys and debt as value&apos;</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">  additionalProperties:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">number</span></span><br></pre></td></tr></tbody></table></figure>
<p>In JSON maps are usually represented or as json array of tuples key-value or as a json object. The json object is the natural way to represent it, but it has an important restriction: keys are strings. In my case I need to represent a map string &#x2192; number, so json object representation fits good. The map values schema are defined using <code>additionalProperties</code> and, only with Json Schema Draft 7 or newer, keys schema are defined using <code>propertyNames</code>.</p>
<p>The main transaction model is described below:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Transaction:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">  properties:</span></span><br><span class="line"><span class="attr">    id:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">    from:</span></span><br><span class="line">      <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">    to:</span></span><br><span class="line">      <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">    at:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">&quot;Insertion datetime&quot;</span></span><br><span class="line"><span class="attr">      format:</span> <span class="string">date-time</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">    value:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">number</span></span><br><span class="line"><span class="attr">    description:</span></span><br><span class="line"><span class="attr">      minLength:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">  required:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">from</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">to</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">id</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">description</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">value</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">at</span></span><br></pre></td></tr></tbody></table></figure>
<p><code>$ref</code> keyword points to the <code>Username</code> schema I defined before.</p>
<p>This model doesn&#x2019;t fit good for my usage, because for each <code>Transaction</code> endpoint I want to apply some policies. A very common example is the <code>id</code> field: when user inserts a new transaction I want to designate the database to fill the <code>id</code> value. When the user creates a new transaction it shouldn&#x2019;t add the <code>id</code> field: that means that I can&#x2019;t use the <code>Transaction</code> model to describe the &#x201C;create transaction&#x201D; request body. Let&#x2019;s look at all restrictions I want to apply on various transaction endpoints:</p>
<ul>
<li><code>id</code> and <code>at</code> are filled by the backend when user adds a new transaction and they are immutable from the API perspective</li>
<li>When user updates a transaction he can&#x2019;t update the <code>from</code> (sender) and <code>to</code> (receiver) fields</li>
<li>When user adds a new transaction he doesn&#x2019;t need to fill the <code>from</code> field because the backend fills it with the logged user</li>
</ul>
<p>To apply these restrictions I create a new model for each endpoint. I&#x2019;m going to refactor <code>Transaction</code> into 3 different models: <code>UpdateTransaction</code>, <code>NewTransaction</code> and <code>Transaction</code>.</p>
<p>These new models lead to a new problem: duplication of model fields definitions. Json schema solves the duplication with schema composition keywords: <code>allOf</code>, <code>anyOf</code> and <code>oneOf</code>. In particular I will use <code>allOf</code> to achieve inheritance of schemas.</p>
<p>This is the final result:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">UpdateTransaction:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">  properties:</span></span><br><span class="line"><span class="attr">    value:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">number</span></span><br><span class="line"><span class="attr">    description:</span></span><br><span class="line"><span class="attr">      minLength:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">NewTransaction:</span></span><br><span class="line"><span class="attr">  allOf:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/UpdateTransaction&apos;</span></span><br><span class="line"><span class="attr">    - properties:</span></span><br><span class="line"><span class="attr">        to:</span></span><br><span class="line">          <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">      required:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">to</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">description</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">value</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">Transaction:</span></span><br><span class="line"><span class="attr">  allOf:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/NewTransaction&apos;</span></span><br><span class="line"><span class="attr">    - required:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">from</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">to</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">id</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">description</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">value</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">at</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        from:</span></span><br><span class="line">          <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">        id:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">        at:</span></span><br><span class="line"><span class="attr">          description:</span> <span class="string">&quot;Insertion datetime&quot;</span></span><br><span class="line"><span class="attr">          format:</span> <span class="string">date-time</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br></pre></td></tr></tbody></table></figure>
<p>The schemas inheritance tree is <code>UpdateTransaction</code>&#x2190;<code>NewTransaction</code>&#x2190;<code>Transaction</code></p>
<h2 id="Endpoints"><a href="#Endpoints" class="headerlink" title="Endpoints"></a>Endpoints</h2><p>OpenAPI document structures the endpoint definitions as follow:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/pathA:</span> <span class="string">{}</span></span><br><span class="line">  <span class="string">/pathB:</span></span><br><span class="line"><span class="attr">    get:</span> <span class="string">{}</span></span><br><span class="line"><span class="attr">    post:</span> <span class="string">{}</span></span><br><span class="line"><span class="attr">    put:</span> <span class="string">{}</span></span><br><span class="line">  <span class="string">/pathC/{paramA}:</span> <span class="string">{}</span></span><br></pre></td></tr></tbody></table></figure>
<p>OpenAPI path strings allow path parameters using <code>{paramName}</code> and doesn&#x2019;t require an explicit definition of query parameters.</p>
<p>In OpenAPI terminology an <strong>operation</strong> is an API endpoint identified by a path and an HTTP method. Every operation could be uniquely identified with an <code>operationId</code>. The OpenAPI Specification (OAS) documents this field as optional, but I strongly suggest to specify it if you don&#x2019;t want to see your tooling explode. Most code generation tooling asserts that <code>operationId</code> is present. If it&#x2019;s not present they try to infeer it from path and http method producing unexpected results.</p>
<p>For each operation we are going to define:</p>
<ul>
<li><code>operationId</code></li>
<li><code>parameters</code> (if any): List of <code>header</code>, <code>path</code>, <code>query</code> and <code>cookie</code> parameters</li>
<li><code>requestBody</code> (if any): Content type and content schema of request bodies</li>
<li><code>responses</code>: Status code with response content type and schemas</li>
</ul>
<p>I also fill the <code>security</code> field for each operation to require a JWT token to execute it.</p>
<h3 id="Transactions-and-Status"><a href="#Transactions-and-Status" class="headerlink" title="Transactions and Status"></a>Transactions and Status</h3><p>Let&#x2019;s start with transaction CRUDs:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th><code>operationId</code></th>
<th>CRUD</th>
<th>Path</th>
<th>HTTP Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create a new transaction</td>
<td><code>createTransaction</code></td>
<td><strong>C</strong>reate</td>
<td><code>/transactions</code></td>
<td>POST</td>
</tr>
<tr>
<td>Get a single transaction</td>
<td><code>getTransaction</code></td>
<td><strong>R</strong>etrieve</td>
<td><code>/transactions/{transactionId}</code></td>
<td>GET</td>
</tr>
<tr>
<td>Get user related transactions</td>
<td><code>getTransactions</code></td>
<td><strong>R</strong>etrieve multiple</td>
<td><code>/transactions</code></td>
<td>GET</td>
</tr>
<tr>
<td>Update a transaction</td>
<td><code>updateTransaction</code></td>
<td><strong>U</strong>pdate</td>
<td><code>/transactions/{transactionId}</code></td>
<td>PUT</td>
</tr>
<tr>
<td>Delete a transaction</td>
<td><code>deleteTransaction</code></td>
<td><strong>D</strong>elete</td>
<td><code>/transactions/{transactionId}</code></td>
<td>DELETE</td>
</tr>
</tbody>
</table>
<p>In OpenAPI:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/transactions:</span></span><br><span class="line"><span class="attr">  get:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">getTransactions</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">application/json:</span></span><br><span class="line"><span class="attr">            schema:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">              items:</span></span><br><span class="line">                <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Transaction&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired token&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  post:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">createTransaction</span></span><br><span class="line"><span class="attr">    requestBody:</span></span><br><span class="line"><span class="attr">      content:</span></span><br><span class="line">        <span class="string">application/json:</span></span><br><span class="line"><span class="attr">          schema:</span></span><br><span class="line">            <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/NewTransaction&apos;</span></span><br><span class="line"><span class="attr">      required:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;201&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Successful response.&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired Token&apos;</span></span><br><span class="line">      <span class="string">&apos;403&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&quot;Trying to create a transaction with receiver not connected to logged user&quot;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br><span class="line"><span class="string">&apos;/transactions/{transactionId}&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">  get:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">getTransaction</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">application/json:</span></span><br><span class="line"><span class="attr">            schema:</span></span><br><span class="line">              <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Transaction&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired Token&apos;</span></span><br><span class="line">      <span class="string">&apos;403&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&quot;Trying to get a transaction where `from` or `to` is not the logged user&quot;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  put:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">updateTransaction</span></span><br><span class="line"><span class="attr">    requestBody:</span></span><br><span class="line"><span class="attr">      content:</span></span><br><span class="line">        <span class="string">application/json:</span></span><br><span class="line"><span class="attr">          schema:</span></span><br><span class="line">            <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/UpdateTransaction&apos;</span></span><br><span class="line"><span class="attr">      required:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;202&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Successful response.&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired Token&apos;</span></span><br><span class="line">      <span class="string">&apos;403&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Trying to update a transaction where `from` is not the logged user&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  delete:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">deleteTransaction</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;204&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Successful response.&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired Token &apos;</span></span><br><span class="line">      <span class="string">&apos;403&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Trying to remove a transaction where `from` is not the logged user&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  parameters:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">transactionId</span></span><br><span class="line"><span class="attr">      in:</span> <span class="string">path</span></span><br><span class="line"><span class="attr">      required:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      schema:</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">string</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note that for all operations under <code>/transactions/{transactionId}</code> path I haven&#x2019;t redefined every time the parameter <code>transactionId</code>: I have defined once at path level.</p>
<p>Status has only the <em>retrieve</em> operation, but I want to let user customize the output based on transactions insertion datetime: clients can use query parameter <code>till</code> to ask the status till the date time provided, excluding newer transactions. You can use it to throw back in your house mate face that he didn&#x2019;t pay the bills for a quite long time.</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/status:</span></span><br><span class="line"><span class="attr">  get:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">getUserStatus</span></span><br><span class="line"><span class="attr">    parameters:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">till</span></span><br><span class="line"><span class="attr">        in:</span> <span class="string">query</span></span><br><span class="line"><span class="attr">        required:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        schema:</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">          format:</span> <span class="string">&apos;date-time&apos;</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">application/json:</span></span><br><span class="line"><span class="attr">            schema:</span></span><br><span class="line">              <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Status&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired token&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="User-and-User-relationships"><a href="#User-and-User-relationships" class="headerlink" title="User and User relationships"></a>User and User relationships</h3><p>The service supports creation and retrieval of users and user relationships. For simplicity I avoided to include <strong>U</strong> and <strong>D</strong> operations for user and user relationships.</p>
<p>I want to expose an endpoint to retrieve all registered users and an endpoint to retrieve only users that have a relationship with logged user:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/users:</span></span><br><span class="line"><span class="attr">  get:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">getUsers</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">application/json:</span></span><br><span class="line"><span class="attr">            schema:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">              items:</span></span><br><span class="line">                <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired token&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br><span class="line"><span class="string">/users/connected:</span></span><br><span class="line"><span class="attr">  get:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">getConnectedUsers</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">application/json:</span></span><br><span class="line"><span class="attr">            schema:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">              properties:</span></span><br><span class="line"><span class="attr">                allowedTo:</span></span><br><span class="line"><span class="attr">                  description:</span> <span class="string">&quot;Users that logged user can bill&quot;</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                  items:</span></span><br><span class="line">                    <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">                allowedFrom:</span></span><br><span class="line"><span class="attr">                  description:</span> <span class="string">&quot;Users that can bill the logged user&quot;</span></span><br><span class="line"><span class="attr">                  type:</span> <span class="string">array</span></span><br><span class="line"><span class="attr">                  items:</span></span><br><span class="line">                    <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired token&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br></pre></td></tr></tbody></table></figure>
<p>In <code>getConnectedUser</code> I prefeered to define the request schema directly inside the request body definition because It&#x2019;s a schema strictly related to this operation and It isn&#x2019;t parent of any other schema.</p>
<p>This is the endpoint to create a user connection (user relationship):</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/users/connected/{userToConnect}:</span></span><br><span class="line"><span class="attr">  post:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">connectUser</span></span><br><span class="line"><span class="attr">    parameters:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">userToConnect</span></span><br><span class="line"><span class="attr">        required:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        in:</span> <span class="string">path</span></span><br><span class="line"><span class="attr">        schema:</span></span><br><span class="line">          <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;201&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;User connected&apos;</span></span><br><span class="line">      <span class="string">&apos;401&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Expired token&apos;</span></span><br><span class="line"><span class="attr">    security:</span></span><br><span class="line"><span class="attr">      - loggedUserToken:</span> <span class="string">[]</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Login-registration-and-JWT"><a href="#Login-registration-and-JWT" class="headerlink" title="Login, registration and JWT"></a>Login, registration and JWT</h3><p>When an user wants to start using this API he must <strong>authenticate</strong> with his credentials following this process:</p>
<ol>
<li>User calls the <code>/login</code> endpoint passing his credentials in the request body</li>
<li>The backend checks if credentials are correct</li>
<li>The backend writes the response with a JWT token containing the username inside the payload</li>
<li>User stores the received JWT token</li>
</ol>
<p>For each request the server must <strong>authorize</strong> the user. The user must include inside each request the header <code>Authorization: Bearer &lt;jwt token&gt;</code>. When the backend receives the request it checks the signature validity and the token expiration time. If the token is valid It parses the payload, where It can read the username of the logged user.</p>
<p>This is the <code>login</code> operation definition:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/login:</span></span><br><span class="line"><span class="attr">  post:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">login</span></span><br><span class="line"><span class="attr">    requestBody:</span></span><br><span class="line"><span class="attr">      content:</span></span><br><span class="line">        <span class="string">application/json:</span></span><br><span class="line"><span class="attr">          schema:</span></span><br><span class="line"><span class="attr">            required:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">username</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">password</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">            properties:</span></span><br><span class="line"><span class="attr">              username:</span></span><br><span class="line">                <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">              password:</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">      required:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Returns the JWT token&apos;</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">text/plain:</span> <span class="string">{}</span></span><br><span class="line">      <span class="string">&apos;400&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Wrong username or password&apos;</span></span><br></pre></td></tr></tbody></table></figure>
<p>The <code>register</code> operation creates a new user and logins it:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/register:</span></span><br><span class="line"><span class="attr">  post:</span></span><br><span class="line"><span class="attr">    operationId:</span> <span class="string">register</span></span><br><span class="line"><span class="attr">    requestBody:</span></span><br><span class="line"><span class="attr">      content:</span></span><br><span class="line">        <span class="string">application/json:</span></span><br><span class="line"><span class="attr">          schema:</span></span><br><span class="line"><span class="attr">            required:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">username</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">password</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">object</span></span><br><span class="line"><span class="attr">            properties:</span></span><br><span class="line"><span class="attr">              username:</span></span><br><span class="line">                <span class="string">$ref:</span> <span class="string">&apos;#/components/schemas/Username&apos;</span></span><br><span class="line"><span class="attr">              password:</span></span><br><span class="line"><span class="attr">                type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">      required:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    responses:</span></span><br><span class="line">      <span class="string">&apos;200&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Returns the JWT Token&apos;</span></span><br><span class="line"><span class="attr">        content:</span></span><br><span class="line">          <span class="string">text/plain:</span> <span class="string">{}</span></span><br><span class="line">      <span class="string">&apos;400&apos;</span><span class="string">:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">&apos;Username already exists&apos;</span></span><br></pre></td></tr></tbody></table></figure>
<p>I don&#x2019;t cover in this tutorial the logout process, but I want to give you a tip: create a whitelist or blacklist of tokens.</p>
<p>As you already saw, each secured operation has the <code>security</code> field:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  - loggedUserToken:</span> <span class="string">[]</span></span><br></pre></td></tr></tbody></table></figure>
<p>The <code>security</code> field is called <strong>security requirement</strong> and it tells the user that he needs <code>loggedUserToken</code> <strong>security schema</strong> to access to this endpoint. Security schemas must be defined under <code>#/components/securitySchemes</code>:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">securitySchemes:</span></span><br><span class="line"><span class="attr">  loggedUserToken:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">bearer</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Some-resources-to-learn-Web-API-Design-and-OpenAPI"><a href="#Some-resources-to-learn-Web-API-Design-and-OpenAPI" class="headerlink" title="Some resources to learn Web API Design and OpenAPI"></a>Some resources to learn Web API Design and OpenAPI</h2><p>I give you a couple of useful links:</p>
<ul>
<li><a href="https://www.restapitutorial.com/" target="_blank" rel="noopener">Rest API Tutorial</a>: Very simple and coincise tutorial for newbies of REST APIs world</li>
<li><a href="http://apistylebook.com/" target="_blank" rel="noopener">http://apistylebook.com/</a>: Collection of API styleguides from different IT companies</li>
<li><a href="https://github.com/OAI/OpenAPI-Specification/" target="_blank" rel="noopener">OpenAPI Specification repository</a>: Contains the spec and examples</li>
<li><a href="https://apis.guru/browse-apis/" target="_blank" rel="noopener">OpenAPI Directory</a>: Collection of OpenAPIs of different public APIs</li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>You can find the complete OpenAPI definition here: <a href="https://github.com/slinkydeveloper/debts-manager/blob/master/src/main/resources/debts_manager_api.yaml" target="_blank" rel="noopener">/src/main/resources/debts_manager_api.yaml</a></p>
<p>After you learnt how to design a REST API, approacching to OpenAPI is very simple. The operation definition is very intuitive because of 1:1 mapping with HTTP (methods, parameters, status codes, content types and so on). The tricky and magic part, for me, is definining and organizing the JSON Schemas. When you define simple models, you tend to put everything inside the same file. But when you raise the complexity using composed schemas, you get flooded by smaller and unclear schemas. My suggestion for you is to document the schemas with <code>title</code> and <code>description</code> keywords and organize these in multiple files.</p>
<p>In next chapter I&#x2019;m going to bootstrap the project and start writing first Vert.x code, stay tuned!</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/openapi/" rel="tag"># openapi</a>
          
            <a href="/tags/vertx/" rel="tag"># vertx</a>
          
            <a href="/tags/development/" rel="tag"># development</a>
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/web-api-contract/" rel="tag"># web api contract</a>
          
            <a href="/tags/openapi-3/" rel="tag"># openapi 3</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Debts-Manager-Tutorial-Introduction/" rel="next" title="Debts Manager Tutorial Part 1: Introduction">
                <i class="fa fa-chevron-left"></i> Debts Manager Tutorial Part 1: Introduction
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Software Engineer</p>
              <p class="site-description motion-element" itemprop="description">Personal blog of Francesco Guardiani, Software Engineer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">28</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/slinkydeveloper" title="GitHub &rarr; https://github.com/slinkydeveloper" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:francescoguard@gmail.com" title="E-Mail &rarr; mailto:francescoguard@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/SlinkyGuardiani" title="Twitter &rarr; https://twitter.com/SlinkyGuardiani" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://stackoverflow.com/users/2399055/francesco-guardiani" title="StackOverflow &rarr; https://stackoverflow.com/users/2399055/francesco-guardiani" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Analysis"><span class="nav-number">1.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Models"><span class="nav-number">2.</span> <span class="nav-text">Models</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Endpoints"><span class="nav-number">3.</span> <span class="nav-text">Endpoints</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Transactions-and-Status"><span class="nav-number">3.1.</span> <span class="nav-text">Transactions and Status</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-and-User-relationships"><span class="nav-number">3.2.</span> <span class="nav-text">User and User relationships</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Login-registration-and-JWT"><span class="nav-number">3.3.</span> <span class="nav-text">Login, registration and JWT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some-resources-to-learn-Web-API-Design-and-OpenAPI"><span class="nav-number">4.</span> <span class="nav-text">Some resources to learn Web API Design and OpenAPI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">5.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Software Engineer</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="//cdn.jsdelivr.net/npm/fancybox@3.0.0/dist/js/jquery.fancybox.pack.js"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
